<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - OACA</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="toast"></div>
    <!-- Edit User Modal -->
    <div class="qm-backdrop" id="editUserModal">
      <div class="qm-card" style="max-width:520px;">
        <div class="qm-header">
          <div class="qm-title">Edit User</div>
          <button class="qm-close" id="editClose">Close</button>
        </div>
        <div class="qm-body">
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Email</label>
              <input id="editEmail" type="text" disabled>
            </div>
            <div class="form-group">
              <label>Role</label>
              <select id="editRole">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label>Airport</label>
              <select id="editAirport"></select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Matricule (8 chars, A–Z, 0–9)</label>
              <input id="editMatricule" type="text" maxlength="8" placeholder="e.g. AB12CD34">
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button class="btn secondary" id="editCancel">Cancel</button>
            <button class="btn" id="editSave">Save Changes</button>
          </div>
          <div id="editInfo" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
    <!-- Airport Selection Modal -->
    <div class="qm-backdrop" id="airportSelectionModal">
      <div class="qm-card" style="max-width: 600px;">
        <div class="qm-header">
          <div class="qm-title">Select Airport</div>
          <button class="qm-close" id="airportModalClose">Close</button>
        </div>
        <div class="qm-body">
          <p style="margin-bottom: 20px; color: var(--muted);">Choose an airport to manage users for that location.</p>
          <div id="airportOptions" class="airport-options-grid">
            <!-- Airport options will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Section Modal -->
    <div class="qm-backdrop" id="editSectionModal">
      <div class="qm-card" style="max-width:520px;">
        <div class="qm-header">
          <div class="qm-title">Edit Section</div>
          <button class="qm-close" id="secEditClose">Close</button>
        </div>
        <div class="qm-body">
          <input type="hidden" id="editSectionId">
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Section Name</label>
              <input id="editSectionName" type="text" placeholder="Enter section name">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Description</label>
              <input id="editSectionDesc" type="text" placeholder="Optional description">
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button class="btn secondary" id="secEditCancel">Cancel</button>
            <button class="btn" id="secEditSave">Save Changes</button>
          </div>
          <div id="secEditInfo" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
    <!-- Edit Question Modal -->
    <div class="qm-backdrop" id="editQuestionModal">
      <div class="qm-card" style="max-width:760px;">
        <div class="qm-header">
          <div class="qm-title">Edit Question</div>
          <button class="qm-close" id="qEditClose">Close</button>
        </div>
        <div class="qm-body">
          <input type="hidden" id="editQuestionId">
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Question Text</label>
              <textarea id="editQuestionText" style="min-height: 80px; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
              <label>Section</label>
              <select id="editQuestionSection"></select>
            </div>
            <div class="form-group">
              <label>Correct Answer</label>
              <select id="editQuestionCorrect">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Option A</label>
              <input id="editAnswerA" type="text">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Option B</label>
              <input id="editAnswerB" type="text">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Option C</label>
              <input id="editAnswerC" type="text">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Option D</label>
              <input id="editAnswerD" type="text">
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button class="btn secondary" id="qEditCancel">Cancel</button>
            <button class="btn" id="qEditSave">Save Changes</button>
          </div>
          <div id="qEditInfo" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
    <div class="qm-backdrop" id="questionModal">
      <div class="qm-card">
        <div class="qm-header">
          <div class="qm-title" id="qmTitle">Assignment Questions</div>
          <button class="qm-close" id="qmClose">Close</button>
        </div>
        <div class="qm-body" id="qmBody"></div>
      </div>
    </div>
    <header>
      <h1>OACA Admin Dashboard</h1>
      <div class="header-actions">
        <span class="muted" id="who"></span>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <h3>Sections</h3>
        <div class="side-nav">
          <button id="tab-users" class="tab">User Management</button>
          <button id="tab-questions" class="tab">Question Management</button>
          <button id="tab-sections" class="tab">Section Management</button>
          <button id="tab-quiz" class="tab">Quiz Management</button>
          <button id="tab-assignments" class="tab">Assignment Management</button>
          <button id="tab-report" class="tab">Report</button>
        </div>
      </aside>
      <main>
        <div class="grid">
          <section id="section-users" class="section">
            <div class="card" id="adminPanel" style="display:none;">
              <div class="airport-management-header">
                <div>
                  <h2>User Management</h2>
                  <p class="muted" id="airportDescription">Select an airport to manage users for that location.</p>
                </div>
                <button class="btn" id="changeAirportBtn" style="display: none;" onclick="showAirportSelectionModal()">Change Airport</button>
              </div>

              <div id="airportManagementContent" style="display: none;">
                <div id="selectedAirportSection" class="selected-airport-section">
                  <!-- Selected airport section will be displayed here -->
                </div>
              </div>
            </div>
          </section>

          <section id="section-questions" class="section">
            <div class="card" id="questionPanel" style="display:none;">
              <h2>Question Management</h2>
              <p class="muted">Manage quiz questions and sections. Create, edit, and delete questions and sections.</p>
              
              <!-- Migration Section 
              <div class="form-section">
                <h3 style="margin: 0 0 16px; font-size: 16px; color: var(--text);">Migrate Questions</h3>
                <p class="muted" style="margin-bottom: 12px;">Import questions from the existing JSON file to the database.</p>
                <button class="btn" onclick="migrateQuestions()">Migrate from JSON File</button>
                <div id="migrationStatus" style="margin-top: 8px;"></div>
              </div>-->

              <!-- Question Management -->
              <div class="form-section">
                <div class="section-header">
                  <h3 style="margin: 0; font-size: 16px; color: var(--text);">Questions</h3>
                  <button class="btn" onclick="showCreateQuestionForm()">Create Question</button>
                </div>
                <div class="form-grid" style="margin-top:8px;">
                  <div class="form-group">
                    <label>Filter by Section</label>
                    <select id="questionSectionFilter" onchange="filterQuestions()">
                      <option value="">All Sections</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Search by Question</label>
                    <input type="text" id="questionSearch" placeholder="Type to search..." oninput="filterQuestions()">
                  </div>
                </div>
                
                <!-- Manual Question Creation Form -->
                <div id="createQuestionForm" style="display: none; margin-bottom: 20px;">
                  <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--text);">Add New Question</h4>
                  
                  <!-- Step 1: Section Selection -->
                  <div id="questionStep1" class="question-step">
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                      <h5 style="margin: 0 0 12px; color: var(--accent); font-size: 14px;">Step 1: Choose Section</h5>
                      <div class="form-group">
                        <label>Select Section for this Question</label>
                        <select id="newQuestionSection" onchange="onSectionSelected()">
                          <option value="">Select a section...</option>
                        </select>
                      </div>
                      <div id="sectionInfo" style="margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; display: none;">
                        <div style="font-size: 12px; color: var(--muted);">
                          <div><strong>Section:</strong> <span id="selectedSectionName"></span></div>
                          <div><strong>Questions in section:</strong> <span id="sectionQuestionCount"></span></div>
                          <div><strong>Target questions:</strong> <span id="sectionTargetCount"></span></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Step 2: Question Details -->
                  <div id="questionStep2" class="question-step" style="display: none;">
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                      <h5 style="margin: 0 0 12px; color: var(--accent); font-size: 14px;">Step 2: Question Details</h5>
                      <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                          <label>Question Text</label>
                          <textarea id="newQuestionText" placeholder="Enter the question text..." style="min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                          <label>Correct Answer</label>
                          <select id="newQuestionCorrect">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Step 3: Answer Options -->
                  <div id="questionStep3" class="question-step" style="display: none;">
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                      <h5 style="margin: 0 0 12px; color: var(--accent); font-size: 14px;">Step 3: Answer Options</h5>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                          <label style="font-size: 12px; color: var(--muted);">Option A</label>
                          <input type="text" id="answerA" placeholder="Answer A" style="width: 100%;">
                        </div>
                        <div>
                          <label style="font-size: 12px; color: var(--muted);">Option B</label>
                          <input type="text" id="answerB" placeholder="Answer B" style="width: 100%;">
                        </div>
                        <div>
                          <label style="font-size: 12px; color: var(--muted);">Option C</label>
                          <input type="text" id="answerC" placeholder="Answer C" style="width: 100%;">
                        </div>
                        <div>
                          <label style="font-size: 12px; color: var(--muted);">Option D</label>
                          <input type="text" id="answerD" placeholder="Answer D" style="width: 100%;">
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Form Navigation -->
                  <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button id="prevStepBtn" class="btn secondary" onclick="prevQuestionStep()" style="display: none;">Previous</button>
                    <button id="nextStepBtn" class="btn" onclick="nextQuestionStep()" style="display: none;">Next</button>
                    <button id="submitQuestionBtn" class="btn" onclick="submitNewQuestion()" style="display: none;">Create Question</button>
                    <button class="btn secondary" onclick="hideCreateQuestionForm()">Cancel</button>
                  </div>
                </div>
                
                <ul id="questionsList" class="users-list"></ul>
              </div>
            </div>
          </section>

          <section id="section-quiz" class="section">
            <div class="card">
              <h2>Quiz Management</h2>
              <p class="muted">Create quiz assignments for individual users or entire airports.</p>
              <div class="form-section">
                <h3 style="margin: 0 0 12px; font-size: 16px;">Create Quiz Assignment</h3>

                <!-- Assignment Mode Selection -->
                <div class="assignment-mode-selector" style="margin-bottom: 20px;">
                  <div class="mode-tabs">
                    <button id="modeIndividual" class="mode-tab active" onclick="setAssignmentMode('individual')">Individual Users</button>
                    <button id="modeAirport" class="mode-tab" onclick="setAssignmentMode('airport')">By Airport</button>
                  </div>
                </div>

                <div class="form-grid">
                  <!-- Individual Users Mode -->
                  <div id="individualModeSection" class="assignment-mode-section">
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label>Search Candidates</label>
                      <input type="text" id="assignUserSearch" placeholder="Type email or matricule..." oninput="renderAssignUsers()">
                    </div>
                    <div class="form-group">
                      <label>Filter by Airport</label>
                      <select id="assignAirportFilter" onchange="renderAssignUsers()"></select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label>Individual Candidates</label>
                      <div id="assignUserList" style="max-height: 260px; overflow: auto; border: 1px solid var(--glass-border); border-radius: 10px; padding: 8px; background: rgba(255,255,255,0.05);"></div>
                    </div>
                  </div>

                  <!-- Airport Mode -->
                  <div id="airportModeSection" class="assignment-mode-section" style="display: none;">
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label>Select Airports</label>
                      <div id="assignAirportList" style="max-height: 300px; overflow: auto; border: 1px solid var(--glass-border); border-radius: 10px; padding: 8px; background: rgba(255,255,255,0.05);"></div>
                      <div class="muted" style="margin-top: 8px; font-size: 12px;">
                        Selecting an airport will assign the quiz to ALL users in that airport.
                      </div>
                    </div>
                  </div>

                  <!-- Number of Questions -->
                  <div class="form-group">
                    <label>Number of Questions</label>
                    <input type="number" id="assignQuestionCount" min="1" max="60" value="60" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg); color: var(--text);">
                    <div class="muted" style="margin-top: 4px; font-size: 12px;">
                      Default: 60 questions (1 hour). Timer adjusts automatically: 1 minute per question.
                    </div>
                  </div>

                  <div class="form-group form-actions">
                    <button id="createBtn" class="btn" onclick="createAssignment()" disabled>Create Quiz</button>
                  </div>
                </div>
                <div id="assignInfo" class="muted" style="margin-top:8px;"></div>
                <div id="assignSuccess" style="display:none; background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; padding:10px; border-radius:6px; margin-top:8px; font-weight:600;"></div>
                <div id="assignError" style="display:none; background:#fef2f2; color:#dc2626; border:1px solid #fecaca; padding:10px; border-radius:6px; margin-top:8px; font-weight:600;"></div>
              </div>
            </div>
          </section>

          <!-- Added new Assignment Management section -->
          <section id="section-assignments" class="section">
            <div class="card">
              <h2>Assignment Management</h2>
              <p class="muted">View and manage all quiz assignments.</p>
              
              <div class="form-section">
                <div class="section-header">
                  <h3 style="margin: 0; font-size: 16px;">Assignments</h3>
                </div>
                <div class="form-grid" style="margin-top:8px;">
                  <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Search Assignments (email/status)</label>
                    <input type="text" id="assignmentSearch" placeholder="e.g. user@domain.com or completed/terminated">
                  </div>
                  <div class="form-group">
                    <label>Filter by Airport</label>
                    <select id="assignmentsAirportFilter"></select>
                  </div>
                </div>
                <ul id="assignmentsList" style="display:grid; grid-template-columns: 1fr; gap:10px;"></ul>
              </div>
            </div>
          </section>

          <section id="section-report" class="section">
            <div class="card" id="scoresPanel" style="display:none;">
              <h2>Report</h2>
              <p class="muted">Overall scores submitted by users.</p>
              <button class="btn secondary" onclick="loadScores()">Refresh Scores</button>
              <ul id="scoresList"></ul>
            </div>
            <div class="card" id="analyticsPanel" style="display:none; margin-top:12px;">
              <div style="margin-bottom: 24px;">
                <h2 style="margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                  <i class="bi bi-graph-up"></i> Analytics & Statistics
                </h2>
                <p class="muted" style="margin: 0;">Comprehensive insights into your aviation testing platform performance</p>
              </div>

              <!-- Quick Stats -->
              <div id="analyticsStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <!-- Stats will be loaded here -->
              </div>

              <!-- Charts Grid -->
              <div id="analyticsChartsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px;">
                <!-- Most Asked Sections Chart -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-bar-chart"></i> Most Asked Sections
                  </h3>
                  <div style="position: relative; height: 300px;">
                    <canvas id="mostAskedSectionsChart"></canvas>
                  </div>
                </div>

                <!-- Test Results by Status Chart -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-pie-chart-fill"></i> Test Results by Status
                  </h3>
                  <div style="position: relative; height: 300px;">
                    <canvas id="testResultsByStatusChart"></canvas>
                  </div>
                </div>

                <!-- Users by Role Chart -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-pie-chart"></i> Users by Role
                  </h3>
                  <div style="position: relative; height: 300px;">
                    <canvas id="usersByRoleChart"></canvas>
                  </div>
                </div>

                <!-- Top Sections Chart -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-graph-up"></i> Top 5 Sections
                  </h3>
                  <div style="position: relative; height: 300px;">
                    <canvas id="topSectionsChart"></canvas>
                  </div>
                </div>
              </div>

              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top: 24px;">
                <label style="font-size:13px; color:var(--muted);">Airport:</label>
                <select id="reportAirportSelect" style="min-width:200px;"></select>
                <button class="btn" onclick="generateAirportReport()">Generate Airport Report</button>
                <button class="btn secondary" onclick="loadAnalyticsCharts()">Refresh Analytics</button>
              </div>
              <div id="airportReportResult" style="margin-top:16px;"></div>
            </div>
            <!-- Assignment Report Modal -->
            <div class="qm-backdrop" id="assignmentReportModal">
              <div class="qm-card" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="qm-header">
                  <div class="qm-title">Assignment Report</div>
                  <button class="qm-close" id="closeAssignmentReport">Close</button>
                </div>
                <div class="qm-body">
                  <p class="muted" style="margin-bottom: 16px;">Detailed answers and per-section results for a specific assignment.</p>
                  <div id="assignmentMeta" style="margin-bottom:20px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid var(--glass-border);"></div>
                  <div id="perSection" style="margin-bottom: 20px;"></div>
                  <div id="answersList"></div>
                </div>
              </div>
            </div>
            <div class="card" id="violationReportsPanel" style="display:none; margin-top:12px;">
              <h2>Rejected Candidates & Violations</h2>
              <p class="muted">Quiz violations and rejections with captured evidence and timestamps.</p>
              <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                <button class="btn secondary" onclick="loadViolationReports()">Refresh Reports</button>
                <button class="btn secondary" onclick="filterRejectedOnly()" id="filterRejectedBtn">Show Rejected Only</button>
                <button class="btn secondary" onclick="showAllReports()" id="showAllBtn" style="display: none;">Show All</button>
              </div>
              <div id="violationReportsList"></div>
            </div>
          </section>

          <section id="section-sections" class="section">
            <div class="card" id="sectionsPanel">
              <h2>Section Management</h2>
              <p class="muted">Create, edit, delete and filter sections for organizing questions.</p>
              <div class="form-section">
                <div class="section-header">
                  <h3 style="margin: 0; font-size: 16px; color: var(--text);">Sections</h3>
                  <button class="btn" onclick="showCreateSectionForm()">Create Section</button>
                </div>
                <div id="createSectionForm" style="display: none; margin-bottom: 20px;">
                  <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--text);">Add New Section</h4>
                  <div class="form-grid">
                    <div class="form-group">
                      <label>Section Name</label>
                      <input type="text" id="newSectionName" placeholder="Enter section name...">
                    </div>
                    <div class="form-group">
                      <label>Number of Questions</label>
                      <input type="number" id="newSectionQuestionCount" placeholder="Enter number of questions..." min="1" max="100">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label>Description (Optional)</label>
                      <input type="text" id="newSectionDescription" placeholder="Enter section description...">
                    </div>
                  </div>
                  <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn" onclick="submitNewSection()">Create Section</button>
                    <button class="btn secondary" onclick="hideCreateSectionForm()">Cancel</button>
                  </div>
                </div>
                <div class="form-grid" style="margin-top:8px; width: 100%;">
                  <div class="form-group" style="min-width: 220px;">
                    <label>Filter by Section</label>
                    <select id="sectionFilter" onchange="filterQuestions()" style="width: 100%;">
                      <option value="">All Sections</option>
                    </select>
                  </div>
                  <div class="form-group" style="min-width: 220px;">
                    <label>Search Sections</label>
                    <input type="text" id="sectionSearch" placeholder="Type to search..." oninput="loadSections()" style="width: 100%;">
                  </div>
                </div>
                <ul id="sectionsList" class="users-list" style="width: 100%;"></ul>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>

  </div>

  <script src="script.js"></script>
  <script>
    // Chart.js configuration
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#6b7280';

    let analyticsCharts = {};

    // Load analytics charts with Chart.js
    async function loadAnalyticsCharts() {
      try {
        // Load stats
        const statsRes = await fetch('/api/stats/dashboard', { credentials: 'include' });
        let stats = {};
        if (statsRes.ok) {
          stats = await statsRes.json();
        }

        // Load most asked data
        const mostAskedRes = await fetch('/api/stats/most-asked', { credentials: 'include' });
        let mostAskedData = { most_asked_sections: [], most_asked_questions: [] };
        if (mostAskedRes.ok) {
          mostAskedData = await mostAskedRes.json();
        }

        // Load user stats
        const usersRes = await fetch('/api/users', { credentials: 'include' });
        let users = [];
        if (usersRes.ok) {
          users = await usersRes.json();
        }

        // Load assignments for test results
        const assignmentsRes = await fetch('/api/quiz-assignments', { credentials: 'include' });
        let assignments = [];
        if (assignmentsRes.ok) {
          assignments = await assignmentsRes.json();
        }

        // Update stats grid
        updateStatsGrid(stats, users, assignments);

        // Destroy existing charts
        Object.values(analyticsCharts).forEach(chart => {
          if (chart) chart.destroy();
        });
        analyticsCharts = {};

        // Most Asked Sections Chart (Bar)
        const sectionsData = mostAskedData.most_asked_sections || [];
        if (sectionsData.length > 0) {
          const sectionsCtx = document.getElementById('mostAskedSectionsChart');
          if (sectionsCtx) {
            analyticsCharts.mostAskedSections = new Chart(sectionsCtx, {
              type: 'bar',
              data: {
                labels: sectionsData.map(s => s.section),
                datasets: [{
                  label: 'Times Asked',
                  data: sectionsData.map(s => s.count || 0),
                  backgroundColor: '#3b82f6',
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                  }
                }
              }
            });
          }
        }

        // Test Results by Status Chart (Pie)
        const passed = assignments.filter(a => a.finished_at && a.passed && !a.terminated).length;
        const failed = assignments.filter(a => a.finished_at && !a.passed && !a.terminated).length;
        const terminated = assignments.filter(a => a.terminated).length;
        
        const testResultsCtx = document.getElementById('testResultsByStatusChart');
        if (testResultsCtx) {
          analyticsCharts.testResults = new Chart(testResultsCtx, {
            type: 'pie',
            data: {
              labels: ['Passed', 'Failed', 'Terminated'],
              datasets: [{
                data: [passed, failed, terminated],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        // Users by Role Chart (Doughnut)
        const adminCount = users.filter(u => u.role === 'admin').length;
        const userCount = users.filter(u => u.role === 'user').length;
        
        const usersRoleCtx = document.getElementById('usersByRoleChart');
        if (usersRoleCtx) {
          analyticsCharts.usersByRole = new Chart(usersRoleCtx, {
            type: 'doughnut',
            data: {
              labels: ['Admins', 'Users'],
              datasets: [{
                data: [adminCount, userCount],
                backgroundColor: ['#667eea', '#f59e0b'],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        // Top Sections Chart (Horizontal Bar)
        if (sectionsData.length > 0) {
          const topSectionsCtx = document.getElementById('topSectionsChart');
          if (topSectionsCtx) {
            const top5 = sectionsData.slice(0, 5);
            analyticsCharts.topSections = new Chart(topSectionsCtx, {
              type: 'bar',
              data: {
                labels: top5.map(s => s.section),
                datasets: [{
                  label: 'Times Asked',
                  data: top5.map(s => s.count || 0),
                  backgroundColor: '#667eea',
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                  }
                }
              }
            });
          }
        }

      } catch (e) {
        console.error('Failed to load analytics charts:', e);
      }
    }

    function updateStatsGrid(stats, users, assignments) {
      const grid = document.getElementById('analyticsStatsGrid');
      if (!grid) return;

      const totalUsers = users.length || stats.total_users || 0;
      const totalAssignments = assignments.length || 0;
      const completedTests = assignments.filter(a => a.finished_at && !a.terminated).length;
      const pendingAssignments = assignments.filter(a => !a.finished_at && !a.terminated).length;

      grid.innerHTML = `
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
          <i class="bi bi-people" style="font-size: 24px; color: #667eea; opacity: 0.8;"></i>
          <div>
            <h4 style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 4px 0;">Total Users</h4>
            <p style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">${totalUsers}</p>
          </div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
          <i class="bi bi-file-earmark-text" style="font-size: 24px; color: #3b82f6; opacity: 0.8;"></i>
          <div>
            <h4 style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 4px 0;">Total Assignments</h4>
            <p style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">${totalAssignments}</p>
          </div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
          <i class="bi bi-calendar-check" style="font-size: 24px; color: #10b981; opacity: 0.8;"></i>
          <div>
            <h4 style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 4px 0;">Completed Tests</h4>
            <p style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">${completedTests}</p>
          </div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
          <i class="bi bi-clock-history" style="font-size: 24px; color: #f59e0b; opacity: 0.8;"></i>
          <div>
            <h4 style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 4px 0;">Pending</h4>
            <p style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">${pendingAssignments}</p>
          </div>
        </div>
      `;
    }

    // Replace old loadAnalyticsChart function
    window.loadAnalyticsChart = loadAnalyticsCharts;
  </script>
</body>
</html>
